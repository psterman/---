<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #FFFFFF;
            color: #2C3E50;
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #E0E0E0;
            background-color: #FFFFFF;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo {
            height: 32px;
            margin-right: 8px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: #2C3E50;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .new-chat-btn {
            background: #EBF5FE;
            color: #3498DB;
            border: 1px solid #D4E6F9;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .new-chat-btn:hover {
            background: #D4E6F9;
        }

        .history-btn {
            background: #F8F9FA;
            color: #5D6D7E;
            border: 1px solid #E5E7EB;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .history-btn:hover {
            background: #E5E7EB;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .chat-history {
            width: 0;
            background: #F8F9FA;
            border-right: 1px solid #E0E0E0;
            overflow-y: auto;
            transition: width 0.3s ease;
        }

        .chat-history.open {
            width: 280px;
        }

        .history-item {
            padding: 12px 16px;
            border-bottom: 1px solid #E0E0E0;
            cursor: pointer;
        }

        .history-item:hover {
            background: #EBF5FE;
        }

        .history-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-date {
            font-size: 12px;
            color: #5D6D7E;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 70px;
        }

        .message-container {
            display: flex;
            margin: 20px 0;
            position: relative;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar.user {
            background: #3498DB;
            color: white;
            font-weight: bold;
        }

        .avatar.assistant {
            background: #F1F3F4;
        }

        .message-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 60px);
        }

        .message {
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            white-space: pre-wrap;
            position: relative;
            max-width: 100%;
        }

        .user-container .message {
            background: #EBF5FE;
            color: #2C3E50;
            border: 1px solid #D4E6F9;
        }

        .assistant-container .message {
            background: #F8F9FA;
            border: 1px solid #E5E7EB;
        }

        .role-label {
            font-size: 14px;
            font-weight: 500;
            color: #5D6D7E;
            margin-bottom: 4px;
        }

        pre {
            background: #2C3E50;
            color: #E5E7EB;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }

        p {
            margin: 8px 0;
        }

        ul,
        ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #E5E7EB;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .message-container:hover .copy-button {
            display: block;
        }

        /* 流动回复效果 */
        .typing-animation {
            display: inline-block;
            position: relative;
            width: 64px;
            height: 18px;
        }

        .typing-dot {
            position: absolute;
            top: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3498DB;
            animation: typing-wave 1.5s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            left: 6px;
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            left: 26px;
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            left: 46px;
            animation-delay: 0.4s;
        }

        @keyframes typing-wave {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }

            30% {
                transform: translateY(-4px);
                opacity: 1;
            }
        }

        #input-area {
            display: flex;
            padding: 16px;
            border-top: 1px solid #E5E7EB;
            background: #FFFFFF;
            position: relative;
        }

        #message-input {
            flex-grow: 1;
            padding: 12px 16px;
            border: 1px solid #D1D5DB;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            transition: border 0.2s;
            min-height: 24px;
            max-height: 120px;
            overflow-y: auto;
            word-break: break-word;
            -webkit-appearance: none;
            appearance: none;
            background-color: #FFFFFF;
        }

        #message-input:empty:before {
            content: attr(placeholder);
            color: #9CA3AF;
            pointer-events: none;
        }

        #message-input:focus {
            border-color: #3498DB;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        #send-button {
            background: #3498DB;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        #send-button:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="logo-container">
            <!-- 海豚 logo -->
            <svg class="logo" width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M13.5 3C13 2 11.5 1 9 1.5C6.5 2 4.5 3.5 3 7C1.5 10.5 0.5 12 0 17C1 17.5 2 16.5 2.5 16C3 17 4.5 18 7 17.5C9.5 17 11.5 15.5 13 12C14.5 8.5 15.5 7 16 2C15 1.5 14 2.5 13.5 3Z"
                    fill="#3498DB" />
                <path d="M13.5 7C14.5 5.5 17 3.5 20 5C23 6.5 24 11 22 16C21 14 18.5 12.5 16 14C16.5 11.5 16 9 13.5 7Z"
                    fill="#3498DB" />
                <path
                    d="M14 16.5C15 18 17.5 20 20.5 18.5C23.5 17 24 12.5 22 7.5C21 9.5 18.5 11 16 9.5C16.5 12 16 14.5 14 16.5Z"
                    fill="#2980B9" />
            </svg>
            <div class="logo-text">DeepSeek</div>
        </div>
        <div class="header-buttons">
            <button class="new-chat-btn" id="new-chat-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 4V20M4 12H20" stroke="#3498DB" stroke-width="2" stroke-linecap="round" />
                </svg>
                新对话
            </button>
            <button class="history-btn" id="history-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#5D6D7E" stroke-width="2"
                        stroke-linecap="round" />
                </svg>
                历史记录
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="chat-history" id="chat-history">
            <!-- 历史记录将在这里动态添加 -->
        </div>

        <div class="chat-container">
            <div id="messages">
                <!-- 消息内容 -->
            </div>

            <div id="input-area">
                <div id="message-input" contenteditable="true" placeholder="输入你的消息..." inputmode="text"
                    data-gramm="false"></div>
                <button id="send-button" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="white" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let isGenerating = false;
        let currentResponseElement = null;
        let currentChatId = Date.now().toString();
        let chatHistory = [];

        // DOM 元素
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const messagesContainer = document.getElementById('messages');
        const historyContainer = document.getElementById('chat-history');
        const newChatBtn = document.getElementById('new-chat-btn');
        const historyBtn = document.getElementById('history-btn');

        // 初始化
        initInputArea();
        loadChatHistory();

        // 功能：初始化输入区域
        function initInputArea() {
            const messageInput = document.getElementById('message-input');

            // 监听输入事件以更新发送按钮状态
            messageInput.addEventListener('input', function () {
                updateSendButton();
                // 如果输入内容过长，自动滚动到底部
                this.scrollTop = this.scrollHeight;
            });

            // 监听键盘事件来处理回车发送
            messageInput.addEventListener('keydown', function (e) {
                // 在Android中，Enter键可能有不同的keyCode
                if ((e.key === 'Enter' || e.keyCode === 13) && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                    return false;
                }
            });

            // 修复Android WebView中contenteditable的placeholder问题 (当内容为空时)
            messageInput.addEventListener('blur', function (e) {
                if (this.textContent.trim() === '') {
                    this.innerHTML = ''; // 清空内容以确保placeholder显示
                }
            });

            // 监听页面大小变化（当输入法弹出时），滚动到底部
            window.addEventListener('resize', function () {
                setTimeout(function () {
                    window.scrollTo(0, document.body.scrollHeight);
                }, 100);
            });

            // 点击发送按钮
            sendButton.addEventListener('click', sendMessage);

            // 初始化发送按钮状态
            updateSendButton();
        }

        // 功能：更新发送按钮状态
        function updateSendButton() {
            const text = messageInput.textContent.trim();
            sendButton.disabled = text === '' || isGenerating;
        }

        // 功能：加载聊天历史记录
        function loadChatHistory() {
            try {
                // 尝试从 localStorage 加载历史记录（如果在 WebView 中可用）
                const savedHistory = localStorage.getItem('deepseekChatHistory');
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                    renderHistoryList();
                }
            } catch (e) {
                console.error('无法加载历史记录:', e);
                chatHistory = [];
            }
        }

        // 功能：保存聊天历史记录
        function saveChatHistory() {
            try {
                localStorage.setItem('deepseekChatHistory', JSON.stringify(chatHistory));
            } catch (e) {
                console.error('无法保存历史记录:', e);
            }
        }

        // 功能：渲染历史记录列表
        function renderHistoryList() {
            historyContainer.innerHTML = '';

            if (chatHistory.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'history-item';
                emptyMsg.innerHTML = '<div class="history-title">没有历史记录</div>';
                historyContainer.appendChild(emptyMsg);
                return;
            }

            // 按时间逆序排列
            const sortedHistory = [...chatHistory].sort((a, b) => b.timestamp - a.timestamp);

            sortedHistory.forEach(chat => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.dataset.chatId = chat.id;

                const date = new Date(chat.timestamp);
                const formattedDate = `${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;

                historyItem.innerHTML = `
                    <div class="history-title">${chat.title || '新对话'}</div>
                    <div class="history-date">${formattedDate}</div>
                `;

                historyItem.addEventListener('click', () => loadChat(chat.id));
                historyContainer.appendChild(historyItem);
            });
        }

        // 功能：切换历史记录面板
        historyBtn.addEventListener('click', function () {
            historyContainer.classList.toggle('open');
        });

        // 功能：创建新对话
        newChatBtn.addEventListener('click', function () {
            startNewChat();
        });

        // 功能：开始新对话
        function startNewChat() {
            // 生成新的聊天ID
            currentChatId = Date.now().toString();

            // 清空消息区域
            messagesContainer.innerHTML = '';

            // 添加新的聊天记录
            const newChat = {
                id: currentChatId,
                title: '新对话',
                timestamp: Date.now(),
                messages: []
            };

            chatHistory.push(newChat);
            saveChatHistory();
            renderHistoryList();

            // 关闭历史面板
            historyContainer.classList.remove('open');
        }

        // 功能：加载指定ID的聊天
        function loadChat(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;
            messagesContainer.innerHTML = '';

            // 渲染消息
            chat.messages.forEach(msg => {
                addMessageToUI(msg.role, msg.content, true);
            });

            // 关闭历史面板
            historyContainer.classList.remove('open');
        }

        // 功能：添加消息到UI
        function addMessageToUI(role, content, isComplete = true) {
            // 如果是新消息
            if (!currentResponseElement || role === 'user' || isComplete) {
                const container = document.createElement('div');
                container.className = 'message-container ' + role + '-container';

                // 添加头像
                const avatar = document.createElement('div');
                avatar.className = 'avatar ' + role;
                if (role === 'user') {
                    avatar.textContent = '你';
                } else {
                    // DeepSeek 海豚 logo 作为头像
                    avatar.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.5 3C13 2 11.5 1 9 1.5C6.5 2 4.5 3.5 3 7C1.5 10.5 0.5 12 0 17C1 17.5 2 16.5 2.5 16C3 17 4.5 18 7 17.5C9.5 17 11.5 15.5 13 12C14.5 8.5 15.5 7 16 2C15 1.5 14 2.5 13.5 3Z" fill="#3498DB"/>
                        <path d="M13.5 7C14.5 5.5 17 3.5 20 5C23 6.5 24 11 22 16C21 14 18.5 12.5 16 14C16.5 11.5 16 9 13.5 7Z" fill="#3498DB"/>
                    </svg>
                    `;
                }

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';

                const roleLabel = document.createElement('div');
                roleLabel.className = 'role-label';
                roleLabel.textContent = role === 'user' ? '你' : 'DeepSeek';
                messageContent.appendChild(roleLabel);

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ' + role;

                // 只在完整消息上处理格式
                if (isComplete && role === 'assistant') {
                    // 处理代码块
                    content = content.replace(/```([\s\S]*?)```/g, function (match, code) {
                        return '<pre><code>' + code.trim() + '</code></pre>';
                    });

                    // 处理行内代码
                    content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
                }

                // 处理换行
                content = content.replace(/\n/g, '<br>');

                messageDiv.innerHTML = content;

                // 如果是助手且不是完整消息，添加流动式打字指示器
                if (role === 'assistant' && !isComplete) {
                    const typingAnimation = document.createElement('div');
                    typingAnimation.className = 'typing-animation';
                    typingAnimation.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
                    messageDiv.appendChild(typingAnimation);
                }

                messageContent.appendChild(messageDiv);

                // 添加复制按钮（只对完整消息添加）
                if (isComplete) {
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-button';
                    copyButton.textContent = '复制';
                    copyButton.onclick = function () {
                        // 获取纯文本内容
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = content;
                        const textContent = tempDiv.textContent || tempDiv.innerText || '';

                        navigator.clipboard.writeText(textContent).then(function () {
                            copyButton.textContent = '已复制';
                            setTimeout(function () {
                                copyButton.textContent = '复制';
                            }, 2000);
                        });
                    };
                    messageDiv.appendChild(copyButton);
                }

                container.appendChild(avatar);
                container.appendChild(messageContent);
                messagesContainer.appendChild(container);

                if (role === 'assistant' && !isComplete) {
                    currentResponseElement = messageDiv;
                } else {
                    currentResponseElement = null;
                }
            } else {
                // 更新现有消息
                content = content.replace(/\n/g, '<br>');
                // 移除末尾的流动式指示器
                const typingAnimation = currentResponseElement.querySelector('.typing-animation');
                if (typingAnimation) {
                    typingAnimation.remove();
                }
                // 添加新内容
                currentResponseElement.innerHTML += content;
                // 重新添加流动式指示器
                if (!isComplete) {
                    const typingAnimation = document.createElement('div');
                    typingAnimation.className = 'typing-animation';
                    typingAnimation.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
                    currentResponseElement.appendChild(typingAnimation);
                }
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 功能：保存消息到历史记录
        function saveMessageToHistory(role, content) {
            // 查找当前聊天记录
            let currentChat = chatHistory.find(c => c.id === currentChatId);

            // 如果没有找到，创建新的
            if (!currentChat) {
                currentChat = {
                    id: currentChatId,
                    title: '新对话',
                    timestamp: Date.now(),
                    messages: []
                };
                chatHistory.push(currentChat);
            }

            // 添加消息
            currentChat.messages.push({
                role,
                content,
                timestamp: Date.now()
            });

            // 如果是第一条用户消息，更新标题
            if (role === 'user' && currentChat.messages.filter(m => m.role === 'user').length === 1) {
                // 取前20个字符作为标题
                currentChat.title = content.length > 20 ? content.substring(0, 20) + '...' : content;
            }

            // 更新时间戳
            currentChat.timestamp = Date.now();

            // 保存历史记录
            saveChatHistory();
            renderHistoryList();
        }

        // 功能：开始响应生成
        function startResponseGeneration() {
            isGenerating = true;
            updateSendButton();
        }

        // 功能：结束响应生成
        function endResponseGeneration() {
            isGenerating = false;
            currentResponseElement = null;
            updateSendButton();

            // 移除打字指示器
            const typingAnimations = document.querySelectorAll('.typing-animation');
            typingAnimations.forEach(animation => animation.remove());

            // 处理最后一条消息中的代码块和行内代码
            const lastMessage = document.querySelector('.message.assistant:last-child');
            if (lastMessage) {
                let content = lastMessage.innerHTML;

                // 移除所有<br>标签以便正确处理代码块
                content = content.replace(/<br>/g, '\n');

                // 处理代码块
                content = content.replace(/```([\s\S]*?)```/g, function (match, code) {
                    return '<pre><code>' + code.trim() + '</code></pre>';
                });

                // 处理行内代码
                content = content.replace(/`([^`]+)`/g, '<code>$1</code>');

                // 重新添加<br>标签用于换行
                content = content.replace(/\n/g, '<br>');

                lastMessage.innerHTML = content;

                // 添加复制按钮
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = '复制';
                copyButton.onclick = function () {
                    // 获取纯文本内容
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';

                    navigator.clipboard.writeText(textContent).then(function () {
                        copyButton.textContent = '已复制';
                        setTimeout(function () {
                            copyButton.textContent = '复制';
                        }, 2000);
                    });
                };
                lastMessage.appendChild(copyButton);
            }
        }

        // 功能：发送消息
        function sendMessage() {
            const messageText = messageInput.textContent.trim();
            if (messageText && !isGenerating) {
                // 添加用户消息到UI
                addMessageToUI('user', messageText);

                // 保存用户消息到历史记录
                saveMessageToHistory('user', messageText);

                // 开始生成回复
                startResponseGeneration();

                // 添加一个空的助手消息作为初始响应
                addMessageToUI('assistant', '', false);

                // 调用 Android 接口发送消息
                AndroidChatInterface.sendMessage(messageText);

                // 清空输入框
                messageInput.textContent = '';
                updateSendButton();
            }
        }

        // 功能：处理流式响应的函数
        function appendToResponse(content) {
            if (isGenerating) {
                addMessageToUI('assistant', content, false);
            }
        }

        // 功能：完成响应的函数
        function completeResponse(finalContent) {
            endResponseGeneration();

            // 如果有完整的最终内容，保存到历史记录
            if (finalContent) {
                saveMessageToHistory('assistant', finalContent);
            } else {
                // 尝试从DOM中获取内容
                const lastMessage = document.querySelector('.message.assistant:last-child');
                if (lastMessage) {
                    let content = lastMessage.innerHTML;
                    // 移除HTML标签以获取纯文本
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';

                    // 保存到历史记录
                    saveMessageToHistory('assistant', textContent);
                }
            }
        }

        // 如果没有历史记录，开始新对话
        if (chatHistory.length === 0) {
            startNewChat();
        } else {
            // 加载最近的聊天
            const recentChat = [...chatHistory].sort((a, b) => b.timestamp - a.timestamp)[0];
            if (recentChat) {
                loadChat(recentChat.id);
            }
        }
    </script>
</body>

</html>